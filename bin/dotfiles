#!/bin/zsh

typeset -A subrepos

dotdir=$HOME/.dotfiles
sub_repos=( zsh "git://github.com/lordzork/zsh-config.git"
						vim "git://github.com/lordzork/dotvim.git")

setup_bin_dir() {
	if [[ -d $HOME/bin ]]; then
		for file in $dotdir/bin/*(.N); do
			if [[ ! -e $HOME/bin/$file:t ]]; then
				ln -s $file $HOME/bin
			fi
		done
	else
		ln -s $dotdir/bin $HOME
	fi
}

link_dotfiles_and_dirs() {
	for file in $dotdir/.*(N); do
		if [[ ! -e $HOME/$file:t ]]; then
			[[ ! $file:t == .git ]] && ln -s $file $HOME
		fi
	done
}

setup_sub_repos() {
	cd $dotdir
	for local_repo_name in ${(k)sub_repos}; do
		git submodule add $sub_repos[$local_repo_name] .$local_repo_name
	done
	git submodule init
	git submodule update
}

case $1 in
  install)
    setup_bin_dir
    link_dotfiles_and_dirs
		setup_sub_repos
    ;;
  push)
		cd $dotdir && git push
    ;;
  update)
		cd $dotdir
		git pull &&
			for dir in .*(/N); do
				cd $dir && git pull && git submodule update
			done
		[[ ! -d $HOME/bin ]] && setup_bin_dir
		link_dotfiles_and_dirs
		;;
	*)
		echo "usage: $0:t <install | push | update>"
esac